<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimentos de Ecoponto Index</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Estilos para o logotipo */
        .logo {
            max-width: 250px; /* Define a largura máxima do logotipo */
            height: auto; /* Mantém a proporção da altura */
        }

        .residuo-item {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .selecionado {
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
    </style>
</head>
<body>
    <img src="logotipo.png" width="200">
    <h2>Atendimento no Ecoponto <span id="nomeEcopontoDisplay"></span></h2>
    <p>Placa: <input type="text" id="placa"></p>
    <p>Data: <input type="date" id="data"></p>
    <p>Hora: <input type="time" id="hora"></p>
    <div>
        <label for="bairro">Bairro:</label>
        <select id="bairro">
            <!-- As opções de bairros serão adicionadas aqui pelo JavaScript -->
        </select>
    </div>

    <div id="residuos-container">
        <!-- Resíduos serão adicionados aqui pelo JavaScript -->
    </div>

    <button id="adicionar">Adicionar Atendimento</button>
    <button id="exportar">Exportar Dados CSV</button>
<br><br>
    <a href="https://ecopontos.github.io/registros.html">Registros atuais</a>
<br><br>
    <a href="https://ecopontos.github.io/configuracao.html">Configuração</a>

   <script>
    // Função para carregar o nome do ecoponto do localStorage e exibir na página
    function carregarNomeEcoponto() {
        var ecoponto = localStorage.getItem('ecoponto');
        if (ecoponto) {
            document.getElementById('nomeEcopontoDisplay').textContent = ecoponto;
        } else {
            document.getElementById('nomeEcopontoDisplay').textContent = 'Não definido';
        }
    }

    // Carregar o nome do ecoponto ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
        carregarNomeEcoponto();
        definirDataHoraAtual();
        setInterval(atualizarHoraAtual, 60000); // Atualiza a hora a cada minuto

        // Adiciona o evento para caixa alta no campo placa
        document.getElementById('placa').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Inicializa o banco de dados e outros elementos
        criarCheckBoxesResiduos();
        inicializarBancoDeDados().catch(error => {
            console.error("Erro ao inicializar o banco de dados:", error);
        });

        setInterval(atualizarHoraAtual, 1000); // Atualiza a hora a cada segundo
    });

    function definirDataHoraAtual() {
        const agora = new Date();
        const dataAtual = agora.toISOString().split('T')[0]; // Data no formato YYYY-MM-DD
        const horaAtual = agora.toTimeString().split(' ')[0]; // Hora no formato HH:MM:SS

        document.getElementById('data').value = dataAtual;
        document.getElementById('hora').value = horaAtual.substring(0, 5); // Ajusta para o formato HH:MM
    }

    function atualizarHoraAtual() {
        const agora = new Date();
        const horaAtual = agora.toTimeString().split(' ')[0]; // Hora no formato HH:MM:SS
        document.getElementById('hora').value = horaAtual.substring(0, 5); // Ajusta para o formato HH:MM
    }

    function criarCheckBoxesResiduos() {
        const residuos = [
            "Amianto", "Animal", "Cápsula de Café", "Eletrônico", "Entulhos",
            "Esponja", "Gesso", "Isopor", "Lâmpadas", "Livro/Revista",
            "Madeiras", "Material de Escrita", "Óleo de Cozinha", "Orgânico",
            "Pilhas/Baterias", "Pneus", "Podas", "Reciclável", "Roupas/Calçados",
            "Sucata/Metal", "Vidros", "Volumosos"
        ];

        const container = document.getElementById('residuos-container');
        residuos.forEach(residuo => {
            const item = document.createElement('div');
            item.className = 'residuo-item';
            item.dataset.residuo = residuo;
            item.textContent = residuo;

            item.addEventListener('click', function() {
                this.classList.toggle('selecionado');
            });

            container.appendChild(item);
        });
    }

    function inicializarBancoDeDados() {
        return new Promise((resolve, reject) => {
            var request = indexedDB.open("nomeDoBanco", 1);

            request.onupgradeneeded = function(event) {
                var db = event.target.result;
                if (!db.objectStoreNames.contains("atendimentos")) {
                    var objectStore = db.createObjectStore("atendimentos", { keyPath: "id", autoIncrement: true });
                    objectStore.createIndex("ecoponto", "ecoponto", { unique: false });
                    objectStore.createIndex("placa", "placa", { unique: false });
                    objectStore.createIndex("data", "data", { unique: false });
                    objectStore.createIndex("hora", "hora", { unique: false });
                    objectStore.createIndex("bairro", "bairro", { unique: false });
                    objectStore.createIndex("residuos", "residuos", { unique: false });
                    objectStore.createIndex("horaRegistro", "horaRegistro", { unique: false });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                console.log("Banco de dados aberto com sucesso");
                resolve();
            };

            request.onerror = function(event) {
                console.error("Erro ao abrir o banco de dados:", event.target.error);
                reject(event.target.error);
            };
        });
    }

    function adicionarAtendimento() {
        const ecoponto = localStorage.getItem('ecoponto') || 'Não definido';
        const placa = document.getElementById('placa').value;
        const data = document.getElementById('data').value;
        const hora = document.getElementById('hora').value;
        const bairro = document.getElementById('bairro').value;

        const residuosSelecionados = Array.from(document.querySelectorAll('#residuos-container .selecionado'))
                                            .map(item => item.dataset.residuo);

        if (placa === "" || data === "" || hora === "" || bairro === "") {
            alert("Por favor, preencha todos os campos obrigatórios.");
            return;
        }

        const agora = new Date();
        const horaAtual = agora.toLocaleTimeString();

        const novoAtendimento = {
            ecoponto: ecoponto,
            placa: placa,
            data: data,
            hora: hora,
            bairro: bairro,
            residuos: residuosSelecionados.join(';'),
            horaRegistro: horaAtual
        };

        console.log("Tentando adicionar o seguinte atendimento ao banco de dados:", novoAtendimento);

        var transaction = db.transaction(["atendimentos"], "readwrite");
        var objectStore = transaction.objectStore("atendimentos");
        var request = objectStore.add(novoAtendimento);

        request.onsuccess = function(event) {
            console.log("Atendimento adicionado com sucesso com o ID:", event.target.result);
            document.getElementById("placa").value = '';
            document.getElementById("data").value = '';
            document.getElementById("hora").value = '';
            document.getElementById("bairro").value = '';
            document.querySelectorAll('#residuos-container .selecionado').forEach(el => el.classList.remove('selecionado'));
        };

        request.onerror = function(event) {
            console.error("Erro ao adicionar atendimento:", event.target.error);
        };
    }

    document.getElementById('adicionar').addEventListener('click', adicionarAtendimento);

    document.addEventListener('DOMContentLoaded', function() {
    criarCheckBoxesResiduos();
    document.getElementById('adicionar').addEventListener('click', adicionarAtendimento);
    document.getElementById('exportar').addEventListener('click', exportarDadosCSV);
    inicializarBancoDeDados();
});

function exportarDadosCSV() {
    const ecoponto = document.getElementById('ecoponto').value;
    const placa = document.getElementById('placa').value;
    const data = document.getElementById('data').value;
    const hora = document.getElementById('hora').value;
    const bairro = document.getElementById('bairro').value;

    const residuosSelecionados = Array.from(document.querySelectorAll('#residuos-container .selecionado'))
                                      .map(item => item.dataset.residuo);

    const csvContent = [
        ['Ecoponto', 'Placa', 'Data', 'Hora', 'Bairro', 'Resíduos', 'Hora Registro'],
        [ecoponto, placa, data, hora, bairro, residuosSelecionados.join(';'), new Date().toLocaleTimeString()]
    ].map(e => e.join(',')).join('\n');

    const link = document.createElement('a');
    link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
    link.download = 'dados_ecoponto.csv';
    link.click();

    limparBancoDeDados();
}

function limparBancoDeDados() {
    if (!db) {
        console.error("Banco de dados não inicializado.");
        return;
    }

    const transaction = db.transaction(["atendimentos"], "readwrite");
    const objectStore = transaction.objectStore("atendimentos");
    
    const request = objectStore.clear();
    
    request.onsuccess = function(event) {
        console.log("Banco de dados limpo com sucesso.");
    };
    
    request.onerror = function(event) {
        console.error("Erro ao limpar o banco de dados:", event.target.errorCode);
    };
}

    document.getElementById('limpar').addEventListener('click', limparBancoDeDados);
</script>
</body>
</html>
