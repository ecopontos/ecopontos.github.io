<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimentos de Ecoponto Index</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Estilos para o logotipo */
        .logo {
            max-width: 250px; /* Define a largura máxima do logotipo */
            height: auto; /* Mantém a proporção da altura */
        }

        .residuo-item {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .selecionado {
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
    </style>
</head>
<body>
    <img src="logotipo.png" width="200">
    <h2>Atendimento no Ecoponto<span id="nomeEcopontoDisplay"></span></h2>
    <p>Placa: <input type="text" id="placa"></p>
    <p>Data: <input type="date" id="data"></p>
    <p>Hora: <input type="time" id="hora"></p>
    <div>
        <label for="bairro">Bairro:</label>
        <select id="bairro">
            <!-- As opções de bairros serão adicionadas aqui pelo JavaScript -->
        </select>
    </div>

    <div id="residuos-container">
        <!-- Resíduos serão adicionados aqui pelo JavaScript -->
    </div>

    <button id="adicionar">Adicionar Atendimento</button>
    <button id="exportar">Exportar Dados CSV</button>

    <script>
        // Função para carregar o nome do ecoponto do localStorage e exibir na página
    function carregarNomeEcoponto() {
        var ecoponto = localStorage.getItem('ecoponto');
        if (ecoponto) {
            document.getElementById('nomeEcopontoDisplay').textContent = ecoponto;
        } else {
            document.getElementById('nomeEcopontoDisplay').textContent = 'Não definido';
        }
    }

    // Carregar o nome do ecoponto ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
        carregarNomeEcoponto();
    });
        function definirDataHoraAtual() {
            const agora = new Date();
            const dataAtual = agora.toISOString().split('T')[0]; // Obtém a data no formato YYYY-MM-DD
            const horaAtual = agora.toTimeString().split(' ')[0]; // Obtém a hora no formato HH:MM:SS

            document.getElementById('data').value = dataAtual;
            document.getElementById('hora').value = horaAtual.substring(0, 5); // Ajusta para o formato HH:MM
        }

        function atualizarHoraAtual() {
            const agora = new Date();
            const horaAtual = agora.toTimeString().split(' ')[0]; // Obtém a hora no formato HH:MM:SS
            document.getElementById('hora').value = horaAtual.substring(0, 5); // Ajusta para o formato HH:MM
        }

        document.addEventListener('DOMContentLoaded', function() {
            definirDataHoraAtual(); // Define a data e hora atuais quando a página é carregada

            const bairros = [
                "Não Informado", "Abraão", "Agronômica", "Armação do Pântano do Sul", "Balneário", "Barra da Lagoa",
                "Bom Abrigo", "Cachoeira do Bom Jesus", "Cacupé", "Campeche", "Canasvieiras",
                "Canto", "Caieira", "Capoeiras", "Carianos",
                "Carvoeira", "Centro", "Coloninha", "Coqueiros", "Córrego Grande",
                "Costa de Dentro", "Costeira do Pirajubaé", "Daniela", "Estreito", "Ingleses", "Itacorubi", "Itaguaçu",
                "Jardim Atlântico", "João Paulo", "José Mendes", "Jurerê", "Jurerê Internacional",
                "Lagoa da Conceição", "Monte Cristo", "Monte Verde", "Morro das Pedras", "Pantanal", "Pântano do Sul",
                "Ponta das Canas", "Praia Brava", "Ratones", "Ribeirão da Ilha", "Rio Tavares", "Saco dos Limões", "Saco Grande",
                "Sambaqui", "Santa Mônica", "Santinho", "Santo Antônio de Lisboa", "Tapera", "Trindade",
                "Vargem Pequena", "Vargem Grande", "Vargem do Bom Jesus", "Rio Vermelho", "Morro do 25", "Serrinha",
                "Morro da Cruz", "Morro do Horácio", "Morro do Quilombo", "Monte Serrat", "Morro da Queimada"
            ];

            const bairroSelect = document.getElementById('bairro');
            bairros.forEach(bairro => {
                const option = document.createElement('option');
                option.value = bairro;
                option.textContent = bairro;
                bairroSelect.appendChild(option);
            });

            const residuos = [
                "Amianto", "Animal", "Cápsula de Café", "Eletrônico", "Entulhos",
                "Esponja", "Gesso", "Isopor", "Lâmpadas", "Livro/Revista",
                "Madeiras", "Material de Escrita", "Óleo de Cozinha", "Orgânico",
                "Pilhas/Baterias", "Pneus", "Podas", "Reciclável", "Roupas/Calçados",
                "Sucata/Metal", "Vidros", "Volumosos"
            ];

            let db;

            function criarCheckBoxesResiduos() {
                const container = document.getElementById('residuos-container');
                residuos.forEach(residuo => {
                    const item = document.createElement('div');
                    item.className = 'residuo-item';
                    item.dataset.residuo = residuo;
                    item.textContent = residuo;

                    item.addEventListener('click', function() {
                        this.classList.toggle('selecionado');
                    });

                    container.appendChild(item);
                });
            }

            function inicializarBancoDeDados() {
                return new Promise((resolve, reject) => {
                    var request = indexedDB.open("nomeDoBanco", 1);

                    request.onupgradeneeded = function(event) {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains("atendimentos")) {
                            var objectStore = db.createObjectStore("atendimentos", { keyPath: "id", autoIncrement: true });
                            objectStore.createIndex("ecoponto", "ecoponto", { unique: false });
                            objectStore.createIndex("placa", "placa", { unique: false });
                            objectStore.createIndex("data", "data", { unique: false });
                            objectStore.createIndex("hora", "hora", { unique: false });
                            objectStore.createIndex("bairro", "bairro", { unique: false });
                            objectStore.createIndex("residuos", "residuos", { unique: false });
                            objectStore.createIndex("horaRegistro", "horaRegistro", { unique: false });
                        }
                    };

                    request.onsuccess = function(event) {
                        db = event.target.result;
                        console.log("Banco de dados aberto com sucesso");
                        resolve();
                    };

                    request.onerror = function(event) {
                        console.error("Erro ao abrir o banco de dados:", event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            function adicionarAtendimento() {
    const ecoponto = localStorage.getItem('ecoponto') || 'Não definido'; // Obtém o valor do localStorage ou define um padrão
    const placa = document.getElementById('placa').value;
    const data = document.getElementById('data').value;
    const hora = document.getElementById('hora').value;
    const bairro = document.getElementById('bairro').value;

    const residuosSelecionados = Array.from(document.querySelectorAll('#residuos-container .selecionado'))
                                        .map(item => item.dataset.residuo);

    if (placa === "" || data === "" || hora === "" || bairro === "") {
        alert("Por favor, preencha todos os campos obrigatórios.");
        return;
    }

    const agora = new Date();
    const horaAtual = agora.toLocaleTimeString();

    const novoAtendimento = {
        ecoponto: ecoponto,
        placa: placa,
        data: data,
        hora: hora,
        bairro: bairro,
        residuos: residuosSelecionados.join(';'),
        horaRegistro: horaAtual
    };

    console.log("Tentando adicionar o seguinte atendimento ao banco de dados:", novoAtendimento);

    var transaction = db.transaction(["atendimentos"], "readwrite");
    var objectStore = transaction.objectStore("atendimentos");
    var request = objectStore.add(novoAtendimento);

    request.onsuccess = function(event) {
        console.log("Atendimento adicionado com sucesso com o ID:", event.target.result);
        document.getElementById("placa").value = '';
        document.getElementById("data").value = '';
        document.getElementById("hora").value = '';
        document.getElementById("bairro").value = '';
        document.querySelectorAll('#residuos-container .selecionado').forEach(el => el.classList.remove('selecionado'));
    };

    request.onerror = function(event) {
        console.error("Erro ao adicionar atendimento:", event.target.error);
    };
}
            document.getElementById('adicionar').addEventListener('click', adicionarAtendimento);

         function exportarParaCSV() {
    var ecoponto = localStorage.getItem('ecoponto') || 'ecoponto'; // Obtém o valor do localStorage ou define um padrão
    var agora = new Date();
    var dataAtual = agora.toISOString().split('T')[0]; // Data no formato YYYY-MM-DD
    var horaAtual = agora.toTimeString().split(' ')[0]; // Hora no formato HH:MM:SS
    var nomeArquivo = `${ecoponto}_${dataAtual}_${horaAtual}.csv`.replace(/:/g, '-'); // Substitui os dois pontos por hífens no nome do arquivo

    var transaction = db.transaction(["atendimentos"], "readonly");
    var objectStore = transaction.objectStore("atendimentos");
    var request = objectStore.getAll();

    request.onsuccess = function(event) {
        var atendimentos = event.target.result;
        if (atendimentos.length === 0) {
            alert("Nenhum atendimento encontrado para exportar.");
            return;
        }

        // Constrói o conteúdo do CSV
        var csvContent = "data:text/csv;charset=utf-8,";
        csvContent += '"ID","Ecoponto","Placa","Data","Hora","Bairro","Resíduos","HoraRegistro"\n';

        atendimentos.forEach(atendimento => {
            csvContent += `"${atendimento.id}","${atendimento.ecoponto}","${atendimento.placa}","${atendimento.data}","${atendimento.hora}","${atendimento.bairro}","${atendimento.residuos}","${atendimento.horaRegistro}"\n`;
        });

        // Cria o link para download
        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", nomeArquivo);
        document.body.appendChild(link);
        link.click();

        // Limpa o banco de dados após o download ser acionado
        limparBancoDeDados();
    };

    request.onerror = function(event) {
        console.error("Erro ao recuperar atendimentos:", event.target.error);
    };
}
function limparBancoDeDados() {
    var transaction = db.transaction(["atendimentos"], "readwrite");
    var objectStore = transaction.objectStore("atendimentos");
    var request = objectStore.clear(); // Limpa todos os registros do object store

    request.onsuccess = function(event) {
        console.log("Banco de dados limpo com sucesso.");
        alert("Dados exportados e banco de dados limpo com sucesso!");
    };

    request.onerror = function(event) {
        console.error("Erro ao limpar o banco de dados:", event.target.error);
        alert("Erro ao limpar o banco de dados. Verifique o console para mais detalhes.");
    };
}

function limparBancoDeDados() {
    var transaction = db.transaction(["atendimentos"], "readwrite");
    var objectStore = transaction.objectStore("atendimentos");
    var request = objectStore.clear(); // Limpa todos os registros do object store

    request.onsuccess = function(event) {
        console.log("Banco de dados limpo com sucesso.");
    };

    request.onerror = function(event) {
        console.error("Erro ao limpar o banco de dados:", event.target.error);
    };
}


            document.getElementById('exportar').addEventListener('click', exportarParaCSV);

            criarCheckBoxesResiduos();
            inicializarBancoDeDados().catch(error => {
                console.error("Erro ao inicializar o banco de dados:", error);
            });

            setInterval(atualizarHoraAtual, 1000); // Atualiza a hora atual a cada segundo
        });
    </script>
</body>
</html>
